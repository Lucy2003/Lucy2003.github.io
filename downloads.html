<html lang="zh-cn">
<head>
<title>Lucy2003的资源下载</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" crossorigin ="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" crossorigin ="anonymous">
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
</head>
<body onhashchange="getNew();" onresize="fixPos();">
<div class="container" >
	<div class="row clearfix" style="min-height:500px">
		<div class="col-md-8 column" >
			<ul class="nav nav-tabs" style="min-height:340px;margin-bottom:20px">
				<li id="tab">
					 <a class="fa fa-arrow-left" href="javascript:;" onclick="getBack();"></a>
				</li>
				<li >
					<input type="text" class="form-control" style="margin-top:3px" id="pathBox"/>
				</li>
				<li>
					<a class="fa fa-clipboard" href="javascript:;" id="copyBtn" data-clipboard-text=""></a>
				</li>
				<li>
					<a class="fa fa-arrow-right" href="javascript:;" onclick="gotoPath();"></a>
				</li>
			</li>
			<table class="table table-hover">
				<thead>
					<tr>
						<th class="col-xs-7">
							文件名
						</th>
						<th class="col-xs-3">
							类型
						</th>
						<th class="col-xs-2">
							大小
						</th>
					</tr>
				</thead>
				<tbody id="listbody">
					<tr>
						<td>正在加载...</td>
						<td></td>
						<td></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="col-md-4 column">
			<ul class="nav nav-tabs" id="xchanger">
				<li class="active" id="tab1">
					 <a href="javascript:;" onclick="changeTab(1);">目录说明</a>
				</li>
				<li id="tab2">
					 <a href="javascript:;" onclick="changeTab(2);">使用说明</a>
				</li>
			</ul>		
			<div class="modal fade modal-container" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
							<h4 class="modal-title" id="myModalLabel">
								下载
							</h4>
						</div>
						<div class="modal-body">
							<p>文件名称：<strong id="filename">正在获取</strong></p>
							<p>文件类型：<strong id="filetype">正在获取</strong></p>
							<p>文件大小：<strong id="filesize">正在获取</strong></p>
							<a style="display:none" id="phoneDownload"></a>
							<br>
							<center>
								<button class="btn btn-primary" onclick="CDNDownload();">CDN下载(快速)</button>
									&nbsp;&nbsp;
								<button class="btn btn-default" onclick="GithubDownload();">直接下载(慢速)</button>
								<br><br>
							<p>或者</p>
								<button class="btn btn-default" onclick="GithubView();">在 Github 上查看</button>
							</center>
						</div>
						<div class="modal-footer">
							 <strong style="float:left;">提示：如果点击下载没有反应，请再试一次！</strong>
							 <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> 
						</div>
					</div>
					
				</div>
				
			</div>
			
			<div id="tab-div" class="lead" style="border: solid 1px #ddd;border-top: none;min-height: 300px;padding:10px">
				<small><div id="tab1-div"></div></small>
				<small><div id="tab2-div" style="display:none;">
					<p><strong>欢迎来到 Lucy2003 的资源下载页！</strong></p>
					<p>这里是 Lucy2003 博客中用到的文件的汇总下载，您可以自行查找并下载。</p>
					<p>CDN 下载速度较快，但是可能更新不及时；直接下载速度较慢，但是一定是最新的。</p>
					<p>需要注意的是，一些浏览器可以自己打开的文件(如 txt )，可能需要手动保存。</p>
				</div></small>
			</div>
		</div>
	</div>
	<HR style="background:#EEEEEE">
	<div class="row clearfix">
		<div class="col-md-12 column">
			<p class="text-center" >
				<strong>本页由<a href="https://github.com/lucy2003">Lucy2003</a>维护</strong>
			</p>
		</div>
	</div>
</div>
<div style="display:none" id="readme-div"></div>
<script>
var cdnPrefix="https://cdn.jsdelivr.net/gh/lucy2003/lucy2003.github.io@master/downloads";
var githubPrefix="https://lucy2003.github.io/downloads";
var githubViewPrefix=""

var selectItem=-1;
var currentDir="/";
var parentDir="/";
var fljson;
var flashTimer;
var flashTimer2;
var temptest;
var flag = IsPC(); //true为PC端，false为手机端

var pathBox=$("#pathBox");
var popFn=$("#filename");
var popFt=$("#filetype");
var popFs=$("#filesize");
var list=$("#listbody");

var originLoad=list.html();

//Run on load
fixPos();
getNew();
$(function() {
    $('.modal-container').on('hide.bs.modal',clearDownload)
});
pathBox.bind('keypress', function (event) {
    if (event.keyCode == "13") {
        gotoPath();
    }
});
var copyBtn = new ClipboardJS('#copyBtn');

// Function defination

function changeTab(id){
	$("#xchanger").find("li").each(function(){$(this).attr("class","");});
	$("#tab-div").find("div").each(function(){$(this).css("display","none");});
	$("#tab" + id).attr("class","active");
	$("#tab" + id + "-div").css("display","");
}



function fixPos(){
	pathBox.width($(".nav-tabs").width()-4*$("#tab").width());
	
}

function clearDownload(){
	popFn.text("正在获取");
	popFt.text("正在获取");
	popFs.text("正在获取");
	selectItem=-1;
}


function showDownload(id){
	selectItem=id;
	popFn.text(fljson.list[id].name);
	popFt.text(getType(fljson.list[id].name));
	popFs.text(getSize(fljson.list[id].size));

}

function getList(){
	if(flashTimer!=0){clearTimeout(flashTimer);}
	if(flashTimer2!=0){clearTimeout(flashTimer2);}
	flashTimer=setTimeout("errorList();",5000);
	var flpath=cdnPrefix+currentDir+"filelist.json";
	var readme=cdnPrefix+currentDir+"ReadMe.md";
	$.getJSON(flpath,function(result,status){
		if(status!="success"){
			errorList();
			return 1;
		}
		clearList();
		clearTimeout(flashTimer);
		console.log("取到文件列表：",result);
		fljson=result;//Save json object
		parentDir=result.parentPath;
		for(var i=result.itemcount-1;i>-1;i--){
			addList(i,result.list[i].name,result.list[i].path,result.list[i].size,result.list[i].type);
		}
    });
	$("#tab1-div").html("<p>正在加载目录说明...</p>");
	flashTimer2=setTimeout("errorReadme();",5000);
	$.get(readme, function(result){
		clearTimeout(flashTimer2);
		$("#tab1-div").html(marked(result));
	});
	
}


function originList(){
	list.html(originLoad);
}

function errorReadme(){
	$("#tab1-div").html("<p>此目录没有 ReadMe.md 文件，故无目录说明</p>");
}

function errorList(){
	clearList();
	list.append("<center>加载失败，请检查您的路径是否正确</center>");
}

function clearList(){
	list.html("");
}

function getType(name){
	var full=name.split(".");
	var extName=full[full.length-1].toLowerCase();
	var type="";
	var filetypeExt=new Array("exe","txt","jpg","png","gif","ico","bmp","md","gz","7z","zip","rar","c","h","cpp","hpp","bat","sh","vbs","js","html","php");
	var filetype=new Array("Windows EXE","文本文档","图片","图片","图片","图标","图片","MarkDown 文件","Gzip 压缩文件","7-Zip 压缩文件","Zip 压缩文件","RAR 压缩文件","C 源码文件","C/C++ 头文件","C++ 源码文件","C++ 头文件","Windows CMD 命令脚本","Linux shell 命令脚本","VBScript 脚本","JavaSrcipt 脚本","HTML 网页","PHP 源文件");
	for (var i=0;i<22;i++){
		if (extName==filetypeExt[i]){
			type=filetype[i];
			return type;
		}
	}
	return extName + " 文件";
}

function getSize(fsize){
	var size;
	if(fsize>1024*1024){size=fsize/1024/1024 + " MBytes";}//CDN最大50MB,不必再x1024
	if(fsize>1024){size=fsize/1024 + " KBytes";}
	if(fsize<=1024){size=fsize + " Bytes";}
	return size;
}


function addList(id,fname,path,fsize,ftype){
	var type="文件夹";
	var name="<a href='#"+ path + "/'>" + fname + "/</a>";
	var size="";
	if(ftype=="File"){
		type=getType(fname);
		name="<a data-target='.modal-container' role='button' data-toggle='modal' href='javascript:;' onclick=\"showDownload('"+ id +"');\" >" + fname + "<//a>";
		size=getSize(fsize);
		if(fsize<=0){return 1;}
		if(fname.toLowerCase()=="readme.md" || fname.toLowerCase()=="readme.txt"){return 1;}
	}
	
	list.append("<tr><td>"+name+"<//td>"+
				"<td>"+type+"<//td>"+
				"<td>"+size+"<//td><//tr>");
	

}


function IsPC() {
    var userAgentInfo = navigator.userAgent;
    var Agents = ["Android", "iPhone",
                "SymbianOS", "Windows Phone",
                "iPad", "iPod"];
    var flag = true;
    for (var v = 0; v < Agents.length; v++) {
        if (userAgentInfo.indexOf(Agents[v]) > 0) {
            flag = false;
            break;
        }
    }
    return flag;
}

function doDownload(prefix){
	var filename=fljson.list[selectItem].name;
	var downloadLink=encodeURI(prefix+fljson.list[selectItem].path);
	if(flag==false){
		location.href=downloadLink;
	}else{
		saveAs(downloadLink,filename);
	}
}


function CDNDownload(){
	doDownload(cdnPrefix);
}

function GithubDownload(){
	doDownload(githubPrefix);
}

function GithubView(){}

function getNew(){
	originList();
	var nowPath=location.hash.replace("#","");
	if (nowPath==""){
		nowPath="/";
		location.hash="#"+nowPath;
		return;
	}
	pathBox.val(decodeURI(nowPath));
	$("#copyBtn").attr("data-clipboard-text",location.toString());
	currentDir=nowPath;
	getList();
}


function getBack(){
	location.hash=parentDir;

}

function gotoPath(){
	location.hash="#" + pathBox.val();

}
</script>
</body>

</html>
